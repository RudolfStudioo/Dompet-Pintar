<!DOCTYPE html>
<html lang="id" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Dompet Pintar</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              darkbg: "#0f172a",
              darkcard: "#1e293b",
              darkinput: "#334155",
            },
          },
        },
      };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }
      .fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Hide Scrollbar for clean UI */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      ::-webkit-scrollbar {
        width: 4px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #475569;
      }
    </style>
  </head>

  <!-- BODY: Background Desktop -->
  <body
    class="bg-gray-200 dark:bg-slate-900 transition-colors duration-300 min-h-screen flex justify-center items-start font-['Plus_Jakarta_Sans']"
  >
    <!-- WRAPPER UTAMA (Limit Width untuk Desktop rasa HP) -->
    <div
      class="w-full max-w-[480px] bg-gray-50 dark:bg-darkbg min-h-screen shadow-2xl relative transition-colors duration-300 overflow-hidden"
    >
      <!-- Input File Hidden -->
      <input
        type="file"
        id="importFile"
        accept=".json"
        class="hidden"
        onchange="processImport(this)"
      />

      <!-- ================= DRAWER (RIWAYAT LENGKAP) ================= -->
      <div
        id="historyDrawer"
        class="absolute inset-0 z-50 transform translate-x-full transition-transform duration-300 bg-gray-50 dark:bg-darkbg flex flex-col h-full"
      >
        <!-- Drawer Header -->
        <div
          class="bg-white dark:bg-darkcard border-b dark:border-slate-700 p-4 flex justify-between items-center shadow-sm z-10"
        >
          <h2 class="font-bold text-lg dark:text-white">Detail Riwayat</h2>
          <button
            onclick="toggleDrawer(false)"
            class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-600 transition"
          >
            <i class="fa-solid fa-xmark text-slate-500 dark:text-slate-300"></i>
          </button>
        </div>

        <!-- Filter Bar -->
        <div
          class="p-4 bg-white dark:bg-darkcard/50 border-b dark:border-slate-700/50"
        >
          <div class="flex justify-between items-center mb-2">
            <p class="text-xs font-bold text-slate-400 uppercase">
              Filter & Urutkan
            </p>
            <span
              id="filteredCount"
              class="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold"
              >0 Data</span
            >
          </div>
          <div class="flex gap-2">
            <select
              id="filterSort"
              onchange="renderHistoryDrawer()"
              class="flex-1 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 text-xs font-bold py-2.5 px-3 rounded-xl border-none outline-none appearance-none cursor-pointer"
            >
              <option value="newest">üìÖ Terbaru</option>
              <option value="oldest">üìÖ Terlama</option>
              <option value="az">üî§ Nama (A-Z)</option>
              <option value="za">üî§ Nama (Z-A)</option>
            </select>
            <select
              id="filterType"
              onchange="renderHistoryDrawer()"
              class="flex-1 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 text-xs font-bold py-2.5 px-3 rounded-xl border-none outline-none appearance-none cursor-pointer"
            >
              <option value="all">Semua Tipe</option>
              <option value="income">Pemasukan</option>
              <option value="expense">Pengeluaran</option>
              <option value="invest">Tabungan</option>
            </select>
          </div>
        </div>

        <!-- Drawer Content (Scrollable) -->
        <div
          id="drawerContent"
          class="flex-1 overflow-y-auto p-4 space-y-3 pb-24"
        >
          <!-- Content will be injected here via JS -->
        </div>
      </div>
      <!-- ================= END DRAWER ================= -->

      <header
        class="relative bg-gradient-to-br from-blue-600 to-indigo-700 dark:from-slate-800 dark:to-slate-900 text-white pt-8 pb-20 px-4 rounded-b-[2.5rem] shadow-xl z-10 transition-colors duration-300"
      >
        <!-- Top Bar -->
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center gap-2">
            <i class="fa-solid fa-wallet text-blue-200 text-xl"></i>
            <h1 class="text-lg font-bold tracking-tight">Dompet Pintar</h1>
          </div>
          <div class="flex gap-2">
            <button
              onclick="exportData()"
              class="bg-white/20 hover:bg-white/30 text-white w-9 h-9 rounded-full flex items-center justify-center transition-all"
              title="Backup JSON"
            >
              <i class="fa-solid fa-cloud-arrow-down text-sm"></i>
            </button>
            <button
              onclick="triggerImport()"
              class="bg-white/20 hover:bg-white/30 text-white w-9 h-9 rounded-full flex items-center justify-center transition-all"
              title="Restore JSON"
            >
              <i class="fa-solid fa-cloud-arrow-up text-sm"></i>
            </button>
            <button
              onclick="toggleDarkMode()"
              class="bg-white/20 hover:bg-white/30 text-white w-9 h-9 rounded-full flex items-center justify-center transition-all"
            >
              <i id="themeIcon" class="fa-solid fa-moon text-sm"></i>
            </button>
            <button
              onclick="resetData()"
              class="bg-red-500/80 hover:bg-red-500 text-white w-9 h-9 rounded-full flex items-center justify-center transition-all shadow-lg shadow-red-500/20"
            >
              <i class="fa-solid fa-trash text-sm"></i>
            </button>
          </div>
        </div>

        <!-- Saldo Utama -->
        <div class="text-center">
          <p
            class="text-blue-100 text-xs font-medium uppercase tracking-wider opacity-80"
          >
            Sisa Saldo Kamu
          </p>
          <h2
            id="totalBalance"
            class="text-4xl font-extrabold mt-2 mb-6 drop-shadow-sm"
          >
            Rp 0
          </h2>
        </div>

        <!-- GRID INFO 3 KOLOM -->
        <div class="grid grid-cols-3 gap-2">
          <div
            class="bg-white/10 backdrop-blur-sm border border-white/10 p-2.5 rounded-2xl flex flex-col justify-between min-h-[80px]"
          >
            <div class="flex items-center gap-1.5 mb-1">
              <div
                class="w-5 h-5 rounded-full bg-green-400/20 flex items-center justify-center text-green-200 text-[10px]"
              >
                <i class="fa-solid fa-arrow-trend-up"></i>
              </div>
              <span
                class="text-[9px] text-blue-100 uppercase font-bold leading-tight"
                >Masuk<br />Bulan Ini</span
              >
            </div>
            <p id="incomeMonth" class="text-sm font-bold truncate">Rp 0</p>
          </div>

          <div
            class="bg-white/10 backdrop-blur-sm border border-white/10 p-2.5 rounded-2xl flex flex-col justify-between min-h-[80px]"
          >
            <div class="flex items-center gap-1.5 mb-1">
              <div
                class="w-5 h-5 rounded-full bg-red-400/20 flex items-center justify-center text-red-200 text-[10px]"
              >
                <i class="fa-solid fa-arrow-trend-down"></i>
              </div>
              <span
                class="text-[9px] text-blue-100 uppercase font-bold leading-tight"
                >Keluar<br />Bulan Ini</span
              >
            </div>
            <p id="expenseMonth" class="text-sm font-bold truncate">Rp 0</p>
          </div>

          <div
            class="bg-white/10 backdrop-blur-sm border border-white/10 p-2.5 rounded-2xl flex flex-col justify-between min-h-[80px]"
          >
            <div class="flex items-center gap-1.5 mb-1">
              <div
                class="w-5 h-5 rounded-full bg-purple-400/20 flex items-center justify-center text-purple-200 text-[10px]"
              >
                <i class="fa-solid fa-piggy-bank"></i>
              </div>
              <span
                class="text-[9px] text-blue-100 uppercase font-bold leading-tight"
                >Tabungan<br />Anda</span
              >
            </div>
            <p id="savingsTotal" class="text-sm font-bold truncate">Rp 0</p>
          </div>
        </div>
      </header>

      <main class="px-5 -mt-12 relative z-20 pb-10">
        <!-- Input Form Container -->
        <div
          class="bg-white dark:bg-darkcard rounded-3xl shadow-xl shadow-slate-200/50 dark:shadow-none border border-slate-100 dark:border-slate-700 overflow-hidden transition-colors duration-300"
        >
          <div class="p-2">
            <div class="bg-slate-100 dark:bg-darkinput rounded-xl p-1 flex">
              <button
                onclick="switchTab('expense')"
                id="tabExpense"
                class="flex-1 py-3 rounded-lg text-sm font-bold shadow-sm bg-white dark:bg-slate-600 text-red-500 transition-all duration-300"
              >
                Pengeluaran
              </button>
              <button
                onclick="switchTab('income')"
                id="tabIncome"
                class="flex-1 py-3 rounded-lg text-sm font-bold text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-all duration-300"
              >
                Pemasukan
              </button>
            </div>
          </div>

          <div class="p-5 pt-2">
            <!-- Form Pengeluaran -->
            <div id="formExpense" class="fade-in space-y-4">
              <div class="relative group">
                <div
                  class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"
                >
                  <i
                    class="fa-solid fa-tag text-slate-400 group-focus-within:text-red-500 transition-colors"
                  ></i>
                </div>
                <input
                  type="text"
                  id="expName"
                  placeholder="Nama (Contoh: Kopi/Saham)"
                  class="w-full pl-10 pr-4 py-3.5 bg-slate-50 dark:bg-darkinput dark:text-white border-0 rounded-xl focus:ring-2 focus:ring-red-500 focus:bg-white dark:focus:bg-darkcard transition-all font-medium text-sm placeholder-slate-400"
                />
              </div>

              <div class="relative group">
                <div
                  class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"
                >
                  <i
                    class="fa-solid fa-layer-group text-slate-400 group-focus-within:text-red-500 transition-colors"
                  ></i>
                </div>
                <select
                  id="expCategory"
                  class="w-full pl-10 pr-10 py-3.5 bg-slate-50 dark:bg-darkinput dark:text-white border-0 rounded-xl focus:ring-2 focus:ring-red-500 focus:bg-white dark:focus:bg-darkcard transition-all font-medium text-sm appearance-none cursor-pointer"
                >
                  <option value="" disabled selected>Pilih Kategori...</option>
                  <option value="Makanan">üçî Makanan & Minuman</option>
                  <option value="Transportasi">üõµ Transportasi</option>
                  <option value="Belanja">üõí Belanja Bulanan</option>
                  <option value="Tagihan">‚ö° Tagihan & Listrik</option>
                  <option value="Hiburan">üé¨ Hiburan</option>
                  <option value="Investasi">üìà Investasi (Tabungan)</option>
                  <option value="Lainnya">üì¶ Lainnya</option>
                </select>
                <div
                  class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none"
                >
                  <i
                    class="fa-solid fa-chevron-down text-xs text-slate-400"
                  ></i>
                </div>
              </div>

              <div class="relative group">
                <div
                  class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"
                >
                  <span
                    class="text-slate-400 font-bold text-sm group-focus-within:text-red-500 transition-colors"
                    >Rp</span
                  >
                </div>
                <input
                  type="number"
                  id="expAmount"
                  placeholder="0"
                  inputmode="numeric"
                  class="w-full pl-10 pr-4 py-3.5 bg-slate-50 dark:bg-darkinput dark:text-white border-0 rounded-xl focus:ring-2 focus:ring-red-500 focus:bg-white dark:focus:bg-darkcard transition-all font-bold text-lg font-mono"
                />
              </div>

              <button
                onclick="submitExpense()"
                class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-red-500/30 active:scale-95 transition-transform flex justify-center items-center gap-2"
              >
                <i class="fa-solid fa-plus"></i> Catat Pengeluaran
              </button>
            </div>

            <!-- Form Pemasukan -->
            <div id="formIncome" class="hidden fade-in space-y-4">
              <div class="relative group">
                <div
                  class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"
                >
                  <i
                    class="fa-solid fa-hand-holding-dollar text-slate-400 group-focus-within:text-green-500 transition-colors"
                  ></i>
                </div>
                <input
                  type="text"
                  id="incSource"
                  placeholder="Sumber Dana (Gaji, Bonus)"
                  class="w-full pl-10 pr-4 py-3.5 bg-slate-50 dark:bg-darkinput dark:text-white border-0 rounded-xl focus:ring-2 focus:ring-green-500 focus:bg-white dark:focus:bg-darkcard transition-all font-medium text-sm placeholder-slate-400"
                />
              </div>

              <div class="relative group">
                <div
                  class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"
                >
                  <span
                    class="text-slate-400 font-bold text-sm group-focus-within:text-green-500 transition-colors"
                    >Rp</span
                  >
                </div>
                <input
                  type="number"
                  id="incAmount"
                  placeholder="0"
                  inputmode="numeric"
                  class="w-full pl-10 pr-4 py-3.5 bg-slate-50 dark:bg-darkinput dark:text-white border-0 rounded-xl focus:ring-2 focus:ring-green-500 focus:bg-white dark:focus:bg-darkcard transition-all font-bold text-lg font-mono"
                />
              </div>

              <button
                onclick="submitIncome()"
                class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-500/30 active:scale-95 transition-transform flex justify-center items-center gap-2"
              >
                <i class="fa-solid fa-download"></i> Catat Pemasukan
              </button>
            </div>
          </div>
        </div>

        <!-- Header Riwayat + Tombol Lihat Detail -->
        <div class="mt-8 mb-4 flex justify-between items-center px-2">
          <h3
            class="font-bold text-slate-700 dark:text-slate-300 text-sm tracking-wide uppercase"
          >
            Riwayat Terbaru
          </h3>
          <button
            onclick="toggleDrawer(true)"
            class="text-xs font-bold text-blue-500 hover:text-blue-600 dark:text-blue-400 flex items-center gap-1 bg-blue-50 dark:bg-blue-500/10 px-3 py-1.5 rounded-full transition-colors active:scale-95"
          >
            Lihat Detail <i class="fa-solid fa-chevron-right text-[10px]"></i>
          </button>
        </div>

        <!-- List Transaksi Utama (Limit 5 items biar bersih) -->
        <div id="transactionList" class="space-y-3 pb-8"></div>
      </main>
    </div>

    <script>
      // --- DARK MODE LOGIC ---
      const themeIcon = document.getElementById("themeIcon");
      if (
        localStorage.theme === "dark" ||
        (!("theme" in localStorage) &&
          window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        document.documentElement.classList.add("dark");
        themeIcon.classList.remove("fa-moon");
        themeIcon.classList.add("fa-sun");
      } else {
        document.documentElement.classList.remove("dark");
        themeIcon.classList.remove("fa-sun");
        themeIcon.classList.add("fa-moon");
      }

      function toggleDarkMode() {
        if (document.documentElement.classList.contains("dark")) {
          document.documentElement.classList.remove("dark");
          localStorage.theme = "light";
          themeIcon.classList.remove("fa-sun");
          themeIcon.classList.add("fa-moon");
        } else {
          document.documentElement.classList.add("dark");
          localStorage.theme = "dark";
          themeIcon.classList.remove("fa-moon");
          themeIcon.classList.add("fa-sun");
        }
      }

      // --- CORE DATA LOGIC ---
      const STORAGE_KEY = "cashflow_data_v2_dark";
      let transactions = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

      function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
        renderDashboard();
        renderList();
        renderHistoryDrawer(); // Refresh drawer if open
      }

      // --- EXPORT / IMPORT ---
      function exportData() {
        if (transactions.length === 0)
          return showAlert("info", "Kosong", "Tidak ada data.");
        const dataStr = JSON.stringify(transactions, null, 2);
        const dataUri =
          "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);
        const linkElement = document.createElement("a");
        linkElement.setAttribute("href", dataUri);
        linkElement.setAttribute(
          "download",
          "dompet_pintar_backup_" +
            new Date().toISOString().slice(0, 10) +
            ".json"
        );
        linkElement.click();
        showAlert("success", "Terunduh", "Simpan file JSON ini.");
      }

      function triggerImport() {
        document.getElementById("importFile").click();
      }
      function processImport(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const json = JSON.parse(e.target.result);
            if (!Array.isArray(json)) throw new Error("Format salah");
            const isDark = document.documentElement.classList.contains("dark");
            Swal.fire({
              title: "Timpa Data?",
              text: "Data lama akan hilang.",
              icon: "question",
              background: isDark ? "#1e293b" : "#ffffff",
              color: isDark ? "#ffffff" : "#334155",
              showCancelButton: true,
              confirmButtonText: "Ya, Import",
              confirmButtonColor: "#3b82f6",
              cancelButtonColor: "#ef4444",
            }).then((result) => {
              if (result.isConfirmed) {
                transactions = json;
                saveData();
                showAlert("success", "Berhasil", "Data dipulihkan!");
              }
              input.value = "";
            });
          } catch (err) {
            showAlert("error", "Gagal", "File rusak.");
            input.value = "";
          }
        };
        reader.readAsText(file);
      }

      // --- DRAWER & FILTER LOGIC (NEW FEATURE) ---
      function toggleDrawer(open) {
        const drawer = document.getElementById("historyDrawer");
        if (open) {
          drawer.classList.remove("translate-x-full");
          renderHistoryDrawer();
        } else {
          drawer.classList.add("translate-x-full");
        }
      }

      function renderHistoryDrawer() {
        const content = document.getElementById("drawerContent");
        const sortType = document.getElementById("filterSort").value;
        const filterType = document.getElementById("filterType").value;

        content.innerHTML = "";

        // 1. Filter Logic
        let filtered = transactions.filter((tx) => {
          if (filterType === "all") return true;
          if (filterType === "income") return tx.type === "income";
          if (filterType === "expense")
            return tx.type === "expense" && tx.category !== "Investasi";
          if (filterType === "invest") return tx.category === "Investasi";
          return true;
        });

        // Update Count Badge
        document.getElementById(
          "filteredCount"
        ).innerText = `${filtered.length} Data`;

        // 2. Sort Logic
        if (sortType === "az")
          filtered.sort((a, b) => a.title.localeCompare(b.title));
        else if (sortType === "za")
          filtered.sort((a, b) => b.title.localeCompare(a.title));
        else if (sortType === "oldest")
          filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
        else filtered.sort((a, b) => new Date(b.date) - new Date(a.date)); // Newest default

        if (filtered.length === 0) {
          content.innerHTML = `<div class="text-center py-20 opacity-50 flex flex-col items-center"><i class="fa-solid fa-filter-circle-xmark text-4xl mb-2"></i><p class="text-sm">Data tidak ditemukan.</p></div>`;
          return;
        }

        // 3. Group by Month Logic
        const grouped = {};
        // Use filtered array to maintain sort order logic if sorting by date
        filtered.forEach((tx) => {
          const date = new Date(tx.date);
          const monthKey = date.toLocaleString("id-ID", {
            month: "long",
            year: "numeric",
          }); // "Januari 2026"
          if (!grouped[monthKey]) grouped[monthKey] = [];
          grouped[monthKey].push(tx);
        });

        // 4. Render Accordions
        Object.keys(grouped).forEach((month, index) => {
          const txs = grouped[month];

          // Calculate Monthly Summary inside Filtered Data
          let mInc = 0,
            mExp = 0,
            mSav = 0;
          txs.forEach((t) => {
            if (t.type === "income") mInc += t.amount;
            else {
              mExp += t.amount;
              if (t.category === "Investasi") mSav += t.amount;
            }
          });

          // HTML Structure for Accordion
          const wrapper = document.createElement("div");
          wrapper.className =
            "bg-white dark:bg-darkcard rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm";

          // Header
          const header = document.createElement("div");
          header.className =
            "p-3 bg-slate-50 dark:bg-slate-800/50 flex flex-col cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition select-none";
          header.onclick = () => {
            const body = document.getElementById(`month-body-${index}`);
            const arrow = document.getElementById(`arrow-${index}`);
            body.classList.toggle("hidden");
            arrow.classList.toggle("rotate-180");
          };

          header.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-sm text-slate-700 dark:text-slate-200">${month}</span>
                    <i id="arrow-${index}" class="fa-solid fa-chevron-down text-xs text-slate-400 transition-transform duration-300"></i>
                </div>
                <div class="flex gap-2 text-[10px] overflow-x-auto no-scrollbar">
                    ${
                      mInc > 0
                        ? `<span class="whitespace-nowrap text-green-600 bg-green-100 dark:bg-green-500/10 px-1.5 py-0.5 rounded font-semibold"><i class="fa-solid fa-arrow-up text-[9px]"></i> ${formatSimple(
                            mInc
                          )}</span>`
                        : ""
                    }
                    ${
                      mExp > 0
                        ? `<span class="whitespace-nowrap text-red-600 bg-red-100 dark:bg-red-500/10 px-1.5 py-0.5 rounded font-semibold"><i class="fa-solid fa-arrow-down text-[9px]"></i> ${formatSimple(
                            mExp
                          )}</span>`
                        : ""
                    }
                    ${
                      mSav > 0
                        ? `<span class="whitespace-nowrap text-purple-600 bg-purple-100 dark:bg-purple-500/10 px-1.5 py-0.5 rounded font-semibold"><i class="fa-solid fa-piggy-bank text-[9px]"></i> ${formatSimple(
                            mSav
                          )}</span>`
                        : ""
                    }
                    ${
                      mInc === 0 && mExp === 0 && mSav === 0
                        ? '<span class="text-slate-400">Tidak ada ringkasan</span>'
                        : ""
                    }
                </div>
            `;

          // Body (List Items)
          const body = document.createElement("div");
          body.id = `month-body-${index}`;
          // Open first month by default
          body.className =
            index === 0
              ? "divide-y divide-slate-100 dark:divide-slate-700"
              : "hidden divide-y divide-slate-100 dark:divide-slate-700";
          if (index === 0)
            header.querySelector("i").classList.add("rotate-180"); // Rotate arrow for first item

          txs.forEach((tx) => {
            const isExp = tx.type === "expense";
            const color = isExp
              ? "text-red-500 dark:text-red-400"
              : "text-green-500 dark:text-green-400";
            const sign = isExp ? "-" : "+";
            body.innerHTML += `
                    <div class="p-3 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-800/30 transition group relative">
                        <div>
                            <p class="text-xs font-bold text-slate-700 dark:text-slate-300">${
                              tx.title
                            }</p>
                            <p class="text-[10px] text-slate-400">${
                              tx.category
                            } ‚Ä¢ ${new Date(tx.date).toLocaleDateString(
              "id-ID",
              { day: "numeric" }
            )}</p>
                        </div>
                        <div class="flex flex-col items-end">
                             <span class="text-xs font-bold ${color}">${sign} ${formatSimple(
              tx.amount
            )}</span>
                             <button onclick="deleteTx(${
                               tx.id
                             })" class="text-[10px] text-slate-300 hover:text-red-500 mt-1 opacity-0 group-hover:opacity-100 transition-opacity">Hapus</button>
                        </div>
                    </div>
                `;
          });

          wrapper.appendChild(header);
          wrapper.appendChild(body);
          content.appendChild(wrapper);
        });
      }

      function formatSimple(num) {
        if (num >= 1000000000) return (num / 1000000000).toFixed(1) + "M";
        if (num >= 1000000) return (num / 1000000).toFixed(1) + "jt";
        if (num >= 1000) return (num / 1000).toFixed(0) + "rb";
        return num;
      }

      // --- DASHBOARD LOGIC (SAMA) ---
      function renderDashboard() {
        let total = 0,
          incM = 0,
          expM = 0,
          inv = 0;
        const now = new Date();
        const curM = now.getMonth();
        const curY = now.getFullYear();

        transactions.forEach((tx) => {
          const d = new Date(tx.date);
          const sameM = d.getMonth() === curM && d.getFullYear() === curY;
          if (tx.type === "income") {
            total += tx.amount;
            if (sameM) incM += tx.amount;
          } else {
            total -= tx.amount;
            if (sameM) expM += tx.amount;
            if (tx.category === "Investasi") inv += tx.amount;
          }
        });

        document.getElementById("totalBalance").innerText = `Rp ${formatRupiah(
          total
        )}`;
        document.getElementById("incomeMonth").innerText = `Rp ${formatRupiah(
          incM
        )}`;
        document.getElementById("expenseMonth").innerText = `Rp ${formatRupiah(
          expM
        )}`;
        document.getElementById("savingsTotal").innerText = `Rp ${formatRupiah(
          inv
        )}`;
      }

      function switchTab(type) {
        const eBtn = document.getElementById("tabExpense");
        const iBtn = document.getElementById("tabIncome");
        const eForm = document.getElementById("formExpense");
        const iForm = document.getElementById("formIncome");
        const active = "shadow-sm bg-white dark:bg-slate-600";
        const inactive =
          "text-slate-400 hover:text-slate-600 dark:hover:text-slate-200";

        if (type === "expense") {
          eBtn.className = `flex-1 py-3 rounded-lg text-sm font-bold transition-all duration-300 text-red-500 ${active}`;
          iBtn.className = `flex-1 py-3 rounded-lg text-sm font-bold transition-all duration-300 ${inactive}`;
          eForm.classList.remove("hidden");
          iForm.classList.add("hidden");
        } else {
          eBtn.className = `flex-1 py-3 rounded-lg text-sm font-bold transition-all duration-300 ${inactive}`;
          iBtn.className = `flex-1 py-3 rounded-lg text-sm font-bold transition-all duration-300 text-green-500 ${active}`;
          eForm.classList.add("hidden");
          iForm.classList.remove("hidden");
        }
      }

      function submitExpense() {
        const n = document.getElementById("expName").value;
        const c = document.getElementById("expCategory").value;
        const a = document.getElementById("expAmount").value;
        if (!n || !c || !a) {
          showAlert("warning", "Ups!", "Lengkapi data.");
          return;
        }
        transactions.unshift({
          id: Date.now(),
          type: "expense",
          title: n,
          category: c,
          amount: parseInt(a),
          date: new Date().toISOString(),
        });
        saveData();
        document.getElementById("expName").value = "";
        document.getElementById("expAmount").value = "";
        showAlert("success", "Tercatat", "Pengeluaran disimpan.");
      }

      function submitIncome() {
        const s = document.getElementById("incSource").value;
        const a = document.getElementById("incAmount").value;
        if (!s || !a) {
          showAlert("warning", "Ups!", "Lengkapi data.");
          return;
        }
        transactions.unshift({
          id: Date.now(),
          type: "income",
          title: s,
          category: "Pendapatan",
          amount: parseInt(a),
          date: new Date().toISOString(),
        });
        saveData();
        document.getElementById("incSource").value = "";
        document.getElementById("incAmount").value = "";
        showAlert("success", "Masuk!", "Pemasukan disimpan.");
      }

      function showAlert(icon, title, text) {
        const isDark = document.documentElement.classList.contains("dark");
        Swal.fire({
          icon,
          title,
          text,
          background: isDark ? "#1e293b" : "#ffffff",
          color: isDark ? "#ffffff" : "#334155",
          confirmButtonColor: "#3b82f6",
          timer: 1500,
          showConfirmButton: false,
        });
      }

      const formatRupiah = (n) => new Intl.NumberFormat("id-ID").format(n);

      function renderList() {
        const list = document.getElementById("transactionList");
        list.innerHTML = "";
        if (transactions.length === 0) {
          list.innerHTML = `<div class="text-center py-10 opacity-50"><p class="text-sm">Belum ada transaksi</p></div>`;
          return;
        }
        // HANYA TAMPILKAN 5 TERAKHIR DI DASHBOARD AGAR RINGAN
        const recent = transactions.slice(0, 5);
        recent.forEach((tx) => {
          const d = new Date(tx.date);
          const isExp = tx.type === "expense";
          const iconBg = isExp
            ? "bg-red-100 text-red-500 dark:bg-red-500/20 dark:text-red-400"
            : "bg-green-100 text-green-500 dark:bg-green-500/20 dark:text-green-400";
          const amtColor = isExp
            ? "text-red-500 dark:text-red-400"
            : "text-green-500 dark:text-green-400";
          const sign = isExp ? "-" : "+";
          const icon = isExp ? "fa-arrow-trend-down" : "fa-arrow-trend-up";

          list.innerHTML += `
            <div class="bg-white dark:bg-darkcard p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex justify-between items-center transition-colors duration-300">
                <div class="flex items-center gap-3">
                    <div class="${iconBg} w-10 h-10 rounded-full flex items-center justify-center text-sm"><i class="fa-solid ${icon}"></i></div>
                    <div><h4 class="font-bold text-slate-700 dark:text-slate-200 text-sm">${
                      tx.title
                    }</h4><p class="text-xs text-slate-400">${
            tx.category
          } ‚Ä¢ ${d.toLocaleDateString("id-ID", {
            day: "numeric",
            month: "short",
          })}</p></div>
                </div>
                <div class="flex flex-col items-end gap-1">
                    <span class="font-bold ${amtColor} text-sm">${sign} Rp ${formatRupiah(
            tx.amount
          )}
          </span>
                    <button onclick="deleteTx(${
                      tx.id
                    })"class="text-xs text-slate-300 hover:text-red-500 px-2"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>`;
        });
      }

      function deleteTx(id) {
        const isDark = document.documentElement.classList.contains("dark");
        Swal.fire({
          title: "Hapus?",
          icon: "warning",
          background: isDark ? "#1e293b" : "#ffffff",
          color: isDark ? "#ffffff" : "#334155",
          showCancelButton: true,
          confirmButtonText: "Ya",
          confirmButtonColor: "#ef4444",
          cancelButtonColor: "#94a3b8",
        }).then((res) => {
          if (res.isConfirmed) {
            transactions = transactions.filter((tx) => tx.id !== id);
            saveData();
          }
        });
      }

      function resetData() {
        const isDark = document.documentElement.classList.contains("dark");

        Swal.fire({
          title: "Reset Total?",
          // HAPUS properti 'text' dan 'caption'. GANTI dengan 'html' di bawah ini:
          html: `
            <div style="color: #ef4444; font-weight: bold; font-size: 1.1rem; margin-bottom: 8px;">
                !!! PERINGATAN !!!
            </div>
            <div style="font-size: 0.9rem; opacity: 0.8;">
                Data tidak bisa dikembalikan jika dihapus
            </div>
        `,
          icon: "warning",
          // Sisanya sama...
          background: isDark ? "#1e293b" : "#ffffff",
          color: isDark ? "#ffffff" : "#334155",
          showCancelButton: true,
          confirmButtonText: "Hapus Semua",
          confirmButtonColor: "#ef4444",
          cancelButtonColor: "#94a3b8",
        }).then((res) => {
          if (res.isConfirmed) {
            transactions = [];
            saveData();
            // Tambahkan feedback visual setelah menghapus
            Swal.fire("Terhapus!", "Data berhasil direset.", "success");
          }
        });
      }

      renderDashboard();
      renderList();
    </script>
  </body>
</html>
